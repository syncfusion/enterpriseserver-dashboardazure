﻿@{
    Layout = null;
    ViewBag.Title = ViewBag.ItemName + " - [[[View Dashboard]]] -" + GlobalAppSettings.SystemSettings.OrganizationName;
    var baseUrl = ViewBag.BaseUrl;
    var dashboardServiceUrl = GlobalAppSettings.SystemSettings.DashboardServiceUrl;
    var itemLocation = ViewBag.ItemLocation as string;
    itemLocation = itemLocation.Replace("\\", "\\\\");
    var enableComment = "true";
    ItemDetail itemDetail = new ItemDetail();
    itemDetail = ViewBag.itemDetail;
    var itemId = ViewBag.ItemId;
    var parentId = ViewBag.ParentId;
    var isUserAuthenticated = "false";
    var isPublic = GlobalAppSettings.SystemSettings.IsMarkItemsPublic && itemDetail.IsPublic ? "true" : "false";
    var _itemId = ViewBag.IsMultiDashboard ? parentId : itemId;
    ViewBag.DateFormat = GlobalAppSettings.SystemSettings.DateFormat;
    ViewBag.TimeFormat = GlobalAppSettings.SystemSettings.TimeFormat ? "HH:mm" : "hh:mm tt";
    var enableView = "true";
    var accessToken = ViewBag.AccessToken;
    var iframeLoaded = "false";
    var externalLogin = Request["externallogin"];
    var hasSSO = Request["hassso"];
    var userId = 0;
    var userName = "";
    var IsMarkItemsPublic = GlobalAppSettings.SystemSettings.IsMarkItemsPublic ? "true" : "false";
    var IsItemPublic = itemDetail.IsPublic ? "true" : "false";
    var itemType = itemDetail.ItemType.ToString().ToLower();
    var publicItemSetttingOffWithoutLoginAndWithOutAccess = (int)ErrorCode.PublicItemSetttingOffWithoutLoginAndWithOutAccess;
    var privateItemSetttingOnWithoutLoginAndWithOutAccessForWinAuth = (int)ErrorCode.PrivateItemSetttingOnWithoutLoginAndWithOutAccessForWinAuth;
    var privateItemSetttingOffWithoutLoginAndWithOutAccessForWinAuth = (int)ErrorCode.PrivateItemSetttingOffWithoutLoginAndWithOutAccessForWinAuth;
    var publicItemSetttingOffWithLoginAndWithOutAccess = (int)ErrorCode.PublicItemSetttingOffWithLoginAndWithOutAccess;
    var privateItemSetttingOnWithoutLoginAndWithOutAccessForWinADAuth = (int)ErrorCode.PrivateItemSetttingOnWithoutLoginAndWithOutAccessForWinADAuth;
    var privateItemSetttingOnWithoutLoginAndWithOutAccessForAzureADAuth = (int)ErrorCode.PrivateItemSetttingOnWithoutLoginAndWithOutAccessForAzureADAuth;
    var privateItemSetttingOnWithLoginAndWithOutAccess = (int)ErrorCode.PrivateItemSetttingOnWithLoginAndWithOutAccess;
    var privateItemSetttingOffWithoutLoginAndWithOutAccessForWinADAuth = (int)ErrorCode.PrivateItemSetttingOffWithoutLoginAndWithOutAccessForWinADAuth;
    var privateItemSetttingOffWithoutLoginAndWithOutAccessForAzureADAuth = (int)ErrorCode.PrivateItemSetttingOffWithoutLoginAndWithOutAccessForAzureADAuth;
    var privateItemSetttingOffWithLoginAndWithOutAccess = (int)ErrorCode.PrivateItemSetttingOffWithLoginAndWithOutAccess;
	var isUnlisted = itemDetail.IsUnlisted ? "true" : "false";
    var unlistedcode = itemDetail.UnlistedCode;
    var isOwner = Convert.ToBoolean(itemDetail.CreatedById == ((HttpContext.Current.User as ServerPrincipal) != null ? (HttpContext.Current.User as ServerPrincipal).UserId : 0)) ? "true" : "false";
}
<!DOCTYPE html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    @if (GlobalAppSettings.SystemSettings.StorageType == (int)StorageType.AzureBlob)
    {
		<link rel="icon" href="@GlobalAppSettings.AzureBlob.AzureBlobStorageUri/@GlobalAppSettings.AzureBlob.AzureBlobStorageContainerName/@GlobalAppSettings.GetStorageMode()/Content/Images/Application/@GlobalAppSettings.SystemSettings.FavIcon" onerror="if (this.href != '~/Content/Images/Application/Favicon.png') this.href = '~/Content/Images/Application/Favicon.png';" />
	}
    else
    {
		<link rel="icon" href="~/Content/Images/Application/@GlobalAppSettings.SystemSettings.FavIcon" onerror="if (this.href != '~/Content/Images/Application/Favicon.png') this.href = '~/Content/Images/Application/Favicon.png';" />
	}
    <title>@ViewBag.Title</title>
    @Styles.Render("~/styles/file-render-ej", DeviceDetection.IsMobile ? "~/styles/file-render-dashboard-mobile" : "~/styles/file-render-dashboard")
    <script>window.destroyAll = function () { try { ej.widget.destroyAll($('.e-js').off()); } catch (e) { } $(document.body).html('-'); CollectGarbage(); };</script>
    @Scripts.Render(DeviceDetection.IsMobile ? "~/scripts/dashboard-render-mobile" : "~/scripts/dashboard-render", "~/scripts/dashboard-render-ejviewer", "~/scripts/dashboard-render-ejvisualizationcontrols", "~/scripts/dashboard-render-ejchart", "~/scripts/embed-dashboards")

    <style>
        html {
            height: 100%;
        }

        #dashboard{
            margin-right: 30px;
        }

         #dashboard_WaitingPopup{
             height: 100% !important;
             width: 100% !important;
             background-color: #fff !important;
         }
        #dashboard_WaitingPopup .e-image {
            background: url('@Url.Content("~/Content/Images/waitingpopup.gif")') no-repeat scroll 0px 18px transparent;
            top : 350px !important;
        }
        .icon {
            text-align: center;
        }

		#custom-errors-embed-dashboard
         {
            font-family: RobotoRegular;
            margin-left: 30px;
            margin-right: 30px;
            margin-top: 50px;
        }
        h2{
            border-bottom: 1px solid #e2e2e2;
            font-size: 30px;
            font-weight: 500;
            padding-bottom: 15px;
        }
         #ul-solution li{
            margin: 10px;
        }
        #ul-possible li{
            margin: 10px;
        }
    </style>
    <script>
    var itemViewShareIframeUrl = "@Url.Action("shareItemView", "items")";
    var favoriteItemUrl = "@Url.Action("MakeFavorite", "Items")";
    var addViewUrl = "@Url.Action("onfiltersave", "DashboardViews")";
    var getSavedViewUrl = "@Url.Action("GetViews", "DashboardViews")";
    var getViewParameterUrl = "@Url.Action("GetDashboardViewParameter", "DashboardViews")";
    var deleteViewUrl = "@Url.Action("DeleteView", "DashboardViews")";
    var updateViewUrl = "@Url.Action("UpdateView", "DashboardViews")";
    var pinWidgetToHomepageUrl = "@Url.Action("PinWidgetToHomepage", "Homepages")";
    var saveViewPopup = "@Url.Action("SaveView", "DashboardViews")";
    var commentPageUrl = "@Url.Action("CommentPartialView", "Comments")";
    var Commentswidgets = "@Url.Action("WidgetCommentPartialView", "Comments")";
    var viewUrl = "@Url.Action("Index", "FileRender")";
    var externalLogin = "@externalLogin";
    var embeddedLoginUrl = "@Url.Action("EmbeddedLogin", "Accounts")";
    var embeddedLogoutUrl = "@Url.Action("EmbeddedLogout","Accounts")";
	var sso = "@hasSSO";
    var canRead = "@ViewBag.CanRead";
	var comment = "";
	var view = "";
	var isUnlisted = @itemDetail.IsUnlisted.ToString().ToLower();
    var unlistedCode = "@itemDetail.UnlistedCode";
    var isOwner = @isOwner;
    var isSlideshow = false;
    var commentSettings = {commentSettings: {
            isDashboardCommented: @Html.Raw(ViewBag.IsDashboardCommented),
            widgets: [@Html.Raw(ViewBag.CommentedWidgets)]
        }};
        function loadPopup() {
            $("#dashboard").ejWaitingPopup();
            $("#dashboard").ejWaitingPopup("show");
            window.location.href = window.location.href.replace(window.location.pathname + window.location.search, "");
        }
        function CommentImageDialogClose() {
            $("#commentImage_popup").ejDialog("close");
            $("#commentImage_popup_image").attr('src', "");
        }
    var publicItemSetttingOffWithoutLoginAndWithOutAccess = @publicItemSetttingOffWithoutLoginAndWithOutAccess;
    var privateItemSetttingOnWithoutLoginAndWithOutAccessForWinAuth = @privateItemSetttingOnWithoutLoginAndWithOutAccessForWinAuth;
    var privateItemSetttingOffWithoutLoginAndWithOutAccessForWinAuth = @privateItemSetttingOffWithoutLoginAndWithOutAccessForWinAuth;
    var publicItemSetttingOffWithLoginAndWithOutAccess = @publicItemSetttingOffWithLoginAndWithOutAccess;
    var privateItemSetttingOnWithoutLoginAndWithOutAccessForWinADAuth = @privateItemSetttingOnWithoutLoginAndWithOutAccessForWinADAuth;
    var privateItemSetttingOnWithoutLoginAndWithOutAccessForAzureADAuth = @privateItemSetttingOnWithoutLoginAndWithOutAccessForAzureADAuth;
    var privateItemSetttingOnWithLoginAndWithOutAccess = @privateItemSetttingOnWithLoginAndWithOutAccess;
    var privateItemSetttingOffWithoutLoginAndWithOutAccessForWinADAuth = @privateItemSetttingOffWithoutLoginAndWithOutAccessForWinADAuth;
    var privateItemSetttingOffWithoutLoginAndWithOutAccessForAzureADAuth = @privateItemSetttingOffWithoutLoginAndWithOutAccessForAzureADAuth;
    var privateItemSetttingOffWithLoginAndWithOutAccess = @privateItemSetttingOffWithLoginAndWithOutAccess;
    </script>
    @{
        if (HttpContext.Current.Request.QueryString["hascomments"] != null && HttpContext.Current.Request.QueryString["hascomments"].ToLower() == "true")
        {
            enableComment = "true";
        }
        else
        {
            enableComment = "false";
        }
        if (HttpContext.Current.Request.QueryString["hasviews"] != null && HttpContext.Current.Request.QueryString["hasviews"].ToLower() == "true")
        {
            enableView = "true";
        }
        else
        {
            enableView = "false";
        }
        if (HttpContext.Current.Request.IsAuthenticated)
        {
            userId = (HttpContext.Current.User as ServerPrincipal).UserId;
            userName = (HttpContext.Current.User as ServerPrincipal).UserName;
        }
    }
</head>
<body style="width: 100%; height: 100%; overflow: hidden">
    <input id="favorite_Item" type="hidden" data-item-id="@ViewBag.ItemId" data-parent-id="@ViewBag.ParentId" data-favorite-value="@ViewBag.IsFavorite">
    <input id="dashboard_Comment" type="hidden" data-item-id="@ViewBag.ItemId">
    <input id="isMultiDashboard" type="hidden" data-item-id="@ViewBag.IsMultiDashboard" data-parent-id="@ViewBag.ParentId">
    <input id="is_mobile" type="hidden" value="@DeviceDetection.IsMobile.ToString().ToLower()">
    <input id="comment_Type" type="hidden" data-item-id="@ViewBag.DataItemId" data-item-type="@ViewBag.ItemType">
    <div id="dashboard" style="height: 100%;"></div>
    <div id="custom-errors-embed-dashboard">
        <h2 id="header"></h2>
        <h4>[[[Possible cause:]]]</h4>
        <ul id="ul-possible"></ul>
        <h4>[[[Solutions:]]]</h4>
        <ul id="ul-solution"></ul>
    </div>
    @if (DeviceDetection.IsMobile)
    {
        <script>
            $(document)
                .ready(function() {
                    //Remove side bar
                    $("ul.options").addClass("displayNone");
                    $("#filter-view").css("display", "none");
                    $("#dashboard-view-toogle").css("display", "none");
                    if(@enableView == false && @enableComment == false){
                        $("#comment-li").remove();
                        $("#view-li").html("");
                        $(".navbar-nav li").removeClass("col-xs-3").addClass("col-xs-6");
                    }
                    else if(@enableComment == false){
                        $("#comment-li").remove();
                        $(".navbar-nav li").removeClass("col-xs-3").addClass("col-xs-4");
                    }
                    else if(@enableView == false){
                        $("#view-li").html("");
                        $(".navbar-nav li").removeClass("col-xs-3").addClass("col-xs-4");
                    }
                });
        </script>

        <nav id="server-mobile-navbar" class="navbar navbar-inverse">
                <div class="container-fluid">
                    <ul class="nav navbar-nav col-xs-12 no-padding no-margin">
                        <li class="col-xs-3 icon">
                            <a href="javascript:void(0)" class="su su-nav-dashboard active"></a>
                        </li>
                        <li class="col-xs-3 icon" id="comment-li">
                            @if (ViewBag.IsDashboardCommented == "true")
                            {
                                <a href="javascript:void(0)" class="su su-with-comment server-comment"></a>
                            }
                            else
                            {
                                <a href="javascript:void(0)" class="su su-without-comment server-comment"></a>
                            }
                        </li>
                        <li class="col-xs-3 icon">
                            <a href="javascript:void(0)" class="su su-filter server-item-view"></a>
                        </li>
                        <li class="col-xs-3 icon" id="view-li">
                            <a href="javascript:void(0)" class="su-view"></a>
                        </li>
                    </ul>
                </div>
        </nav>
    }
    @Html.Partial("_DashboardViews")
    @Html.Partial("../Home/PublicEmbedDashboardViewDenied")

    <div id="commentModuleContainer" class="displayNone" style="background-image: url('@Url.Content("~/Content/Images/waitingpopup.gif")'); background-color: #fff; background-repeat: no-repeat; background-position: 50% 50%;">
        <iframe id="commentModuleContainer_iframe" class="comment-popup-frame" data-item-id="@ViewBag.ItemId" style="height: 100%; width: 100%;"></iframe>
    </div>
    <iframe id="delete_popup_iframe" class="comment-popup-frame displayNone" allowtransparency="true" style="position: absolute;"></iframe>

    <div id="widgetCommentModuleContainer" class="displayNone" style="background-image: url('@Url.Content("~/Content/Images/waitingpopup.gif")'); background-color: #fff; background-repeat: no-repeat; background-position: 50% 50%; z-index: 1000001;">
        <iframe id="widgetCommentModuleContainer_iframe" class="comment-popup-frame" style="height: 100%; width: 100%;"></iframe>
    </div>

    <div id="viewShare_popup" class="col-md-12 DisplayNone">
        <div id="sharepopup_wrapper_WaitingPopup" class="e-waitpopup-sharepopup">
            <span class="e-image" style="top: 161px;"></span>
        </div>
        <iframe id="viewShare_popup_iframe" class="EditIframe"></iframe>
    </div>
    <div class="ViewShare_popup_shadow"></div>
    @* ******************* Please add new iframes below this line *************** *@
    <div id="commentImage_popup" class="col-md-12 no-padding hidden">
        <div class="col-lg-12 no-padding" id="PopupContainer">
            <div class="col-md-12">
                <div class="col-xs-12 no-padding" style="float:right">
                    <a href="javascript:void(0);" onclick="CommentImageDialogClose()" class="PopupClose closePopupImage"><span class="su su-close"></span></a>
                </div>
            </div>
            <div class="dialogBody col-xs-12 no-padding">
                <img id="commentImage_popup_image" src="" style="width: 100%;">
            </div>
        </div>
    </div>
    <div id="pin-widget-popup" data-item-id="@(parentId != null ? parentId : itemId)" data-widget-id="" data-widget-name="">
        <iframe id="pin-widget-popup-iframe" class="" style="height: 100%; width: 100%;"></iframe>
    </div>
    <div id="save-view-popup" data-item-id="@(parentId != null ? parentId : itemId)" data-widget-id="" data-widget-name="">
        <iframe id="save-view-popup-iframe" class="" style="height: 100%; width: 100%;"></iframe>
    </div>
    <div id="success-alert">
        <div id="image-container">
            <div class="image-holder">
                <span class="su su-tick" alt="Success Icon"></span>
            </div>
        </div>
        <div id="message">
            <h1 id="message-header"></h1>
            <span id="message-content"></span>
        </div>
        <div class="close-div">
            <span id="close-content">[[[Close]]]</span>
    </div>
    </div>
    <div id="warning-alert">
        <div id="image-container">
            <span class="su su-warning-alt" alt="Warning Icon"></span>
        </div>
        <div id="message">
            <h1 id="message-header"></h1>
            <span id="message-content"></span>
        </div>
        <div class="close-div">
            <span id="close-content">[[[Close]]]</span>
        </div>
    </div>
</body>
@if (HttpContext.Current.Request.IsAuthenticated)
{
    isUserAuthenticated = "true";
}
else
{
    isUserAuthenticated = "false";
}
@if (!HttpContext.Current.Request.IsAuthenticated)
{
    <script>
            $(document).ready(function () {
                if (externalLogin != null && externalLogin.toLowerCase() == "windowsad" &&
				sso != null && sso.toLowerCase() == "true") {
                    $.ajax({
                        type: "GET",
                        url: "@baseUrl"+"/windowsauthentication/account/login",
                        data: { },
                        cache: false,
                        contentType: "application/json; charset=utf-8",
                        statusCode: {
                            200: function(result) {
                                if (result.Success == true) {
                                    window.location.href = window.location.href;
                                } else {
                                    $(".error-message").css("display", "block");
                                }
                            },
                        },
                        dataType: "json",
                        success: function(result) { },
                        error :  function(result) { }
                  });
                }
            });
    </script>
}
    else
    {
        <script>
            $(document).ready(function () {
                if (externalLogin != "" && externalLogin.toLowerCase() == "windowsad") {
                        if(@isPublic == true|| @isUnlisted == true){
                                        enableComment = "false";
                                        enableView = "false";
                                        renderDashboard(comment,view);
                        }
                        else if(canRead.toLowerCase() == "true")
                        {
                            enableComment = "false";
                            enableView = "false";
                            renderDashboard(comment,view);
                        }
                        else if(@IsMarkItemsPublic == false && @IsItemPublic == true && canRead.toLowerCase() == "false" && isUnlisted != true)
                        {
                            CustomErrorMessage(@publicItemSetttingOffWithoutLoginAndWithOutAccess,"@itemType");
                        }
                        else if(@IsMarkItemsPublic == true && @IsItemPublic == false && canRead.toLowerCase() == "false" && isUnlisted != true)
                        {
                            CustomErrorMessage(@privateItemSetttingOnWithoutLoginAndWithOutAccessForWinAuth, "@itemType");
                        }
                        else if(@IsMarkItemsPublic == false && @IsItemPublic == false && canRead.toLowerCase() == "false" && isUnlisted != true)
                        {
                            CustomErrorMessage(@privateItemSetttingOffWithoutLoginAndWithOutAccessForWinAuth, "@itemType");
                        }
                        else{
                            window.location.href = "@baseUrl"+"/login";
                        }
                    }
            });
        </script>
    }

<script type="text/javascript">
    var userId = "@userId";
    var userName = "@userName";
    var viewId = "@ViewBag.ViewId";
    var item_Id = "@ViewBag.ItemId";
    var isMultiDashboard = "@ViewBag.IsMultiDashboard";
    var childDesignerId = "@ViewBag.ChildDesignerId";
    var enableComment = "@enableComment";
    var pageurl = "@HttpContext.Current.Request.Url.LocalPath";
    var baseUrl = "@GlobalAppSettings.SystemSettings.BaseUrl";
    var dashboardServiceUrl = "@GlobalAppSettings.SystemSettings.DashboardServiceUrl";
    var enableView = "@enableView";
    var token = "@accessToken";
    var isUserAuthenticated = "@isUserAuthenticated";
    var parentRefUrl = (window.location != window.parent.location) ? document.referrer : document.location.href.replace(document.location.pathname + document.location.search, "");
    if(parentRefUrl == ""){
        var parentUrl = "";
    }
    else {
        var parentUrl = parentRefUrl.match(/:\/\/(.[^/]+)/)[1];
    }
    var iframeRefUrl=window.location.href;
    var iframeUrl=iframeRefUrl.match(/:\/\/(.[^/]+)/)[1];

    $(document).ready(function () {
        $(window).resize(function() {
            ResizePopup();
            if($("#is_mobile").val() == "true"){
                $("#dashboard").css("height", $(window).height() - 50 + "px");
            }
            if($(".su-sidebar-collapse").length <= 0){
                setWidth();
            } else {
                if ($("#comments, #filters, #views").hasClass('active')) {
                    $("#dashboard").css("width", $(window).width() - 450 + "px");
                }
            }
        });

        $(window).bind('popstate',
            function(e) {
                applyFilter();
            });

        window.addEventListener('message', receiveMessage, false);
        function receiveMessage(event) {
            var comment = "";
            var view = "";
            if (event.data) {
                if (iframeUrl == parentUrl) {
                    applyFilter();
                }
                else {
                    var messageData = JSON.parse(event.data);
                    if(messageData["access_token"] != ""  && messageData["access_token"] != undefined){
                        token = messageData["access_token"];
                        var te = "@Html.Raw(itemLocation)";
                        $.ajax({
                            type: "POST",
                            url: embeddedLoginUrl,
                            data: {
                                token:token,
                                itemPath:te
                            },
                            success: function(obj) {
                                if (obj.data != null && obj.data.Status == true) {
                                    userId = obj.data.UserId;
                                    userName = obj.data.UserName;
                                    isUserAuthenticated = true;
                                    var iframeUrl = iframeRefUrl.substring(iframeRefUrl.indexOf('?')+1,iframeRefUrl.length);
                                    comment = iframeUrl.substring(iframeUrl.indexOf('=')+1,iframeUrl.indexOf('&'));
                                    view = iframeUrl.substring(iframeUrl.indexOf('=',iframeUrl.indexOf('=')+1)+1,iframeUrl.indexOf('&',iframeUrl.indexOf('&') + 1));
                                    enableComment = (comment == "true")? "true":"false";
                                    enableView = (view == "true")? "true":"false";
                                    if($("#dashboard").data("ejDashboardViewer") != null){
                                        if(enableComment.toLowerCase() == "false"){
                                            $("ul.options #comments").css("display","none");
                                        }
                                        else{
                                            $("ul.options #comments").css("display","block");
                                        }
                                        if(enableView.toLowerCase() == "false"){
                                            $("ul.options #views").css("display","none");
                                        }
                                        else{
                                            $("ul.options #views").css("display","block");
                                        }
                                        $("#dashboard").data("ejDashboardViewer").model.filterOverviewSettings.showSaveIcon = (view == "true")? true:false;
                                        $("#dashboard").data("ejDashboardViewer").model.filterOverviewSettings.showSaveAsIcon = (view == "true")? true:false;
                                        $("#dashboard").data("ejDashboardViewer").model.filterOverviewSettings.showViewSavedFilterIcon = (view == "true")? true:false;
                                        if($("#dashboard").data("ejDashboardViewer").model.allowComment == false && enableComment == "true"){
                                            $("#dashboard").data("ejDashboardViewer")._setModel({"allowComment":(comment == "true")? true:false});
                                        }
                                    }
                                    else{
                                        renderDashboard(comment,view);
                                        $("#dashboard").data("ejDashboardViewer").model.accessToken = token;
                                    }
                                }
                                else{
                                    if (@isPublic == true || @isUnlisted == true && isUserAuthenticated.toLowerCase() == "false") {
                                        enableComment = "false";
                                        enableView = "false";
                                        renderDashboard(comment,view);
                                    } else{
                                        CustomErrorMessage(obj.data.ErrorCode,"@itemType");

                                    }
                                }
                            }
                        });
                    }
                    else{
                        token = token;
                    }
                }
            }
		else{
		    if(@IsMarkItemsPublic == false && @IsItemPublic == true && isUnlisted != true)
		    {
                    CustomErrorMessage(@publicItemSetttingOffWithoutLoginAndWithOutAccess,"@itemType");
		    }
		    else if(@IsMarkItemsPublic == true && @IsItemPublic == false && isUnlisted != true)
		    {
                    CustomErrorMessage(@privateItemSetttingOnWithoutLoginAndWithOutAccessForWinAuth, "@itemType");
		    }
		    else if(@IsMarkItemsPublic == false && @IsItemPublic == false && isUnlisted != true)
		    {
                    CustomErrorMessage(@privateItemSetttingOffWithoutLoginAndWithOutAccessForWinAuth, "@itemType");
		    }
		}
        }

        if (externalLogin != null && externalLogin.toLowerCase() == "azuread" && sso != null && sso.toLowerCase() == "true")
        {
            if (isUserAuthenticated.toLowerCase() == "true"){
                if(@IsMarkItemsPublic == false && @IsItemPublic == true && canRead.toLowerCase() == "false" && isUnlisted != true)
                {
                    CustomErrorMessage(@publicItemSetttingOffWithoutLoginAndWithOutAccess,"@itemType");
                }
                else if(@IsMarkItemsPublic == true && @IsItemPublic == false && canRead.toLowerCase() == "false" && isUnlisted != true)
                {
                    CustomErrorMessage(@privateItemSetttingOnWithoutLoginAndWithOutAccessForWinAuth, "@itemType");
                }
                else if(@IsMarkItemsPublic == false && @IsItemPublic == false && canRead.toLowerCase() == "false" && isUnlisted != true)
                {
                    CustomErrorMessage(@privateItemSetttingOffWithoutLoginAndWithOutAccessForWinAuth, "@itemType");
                }
                else
                {
            renderDashboard(comment,view);
        }
        }
		else{
            if (@isPublic == true|| @isUnlisted == true) {
		 enableComment = "false";
		 enableView = "false";
		 renderDashboard(comment,view);
            } else {
		window.location.href = "@baseUrl"+"/login";
		}
		}
		}
		if(sso.toLowerCase() == "false"){
            if (isUserAuthenticated.toLowerCase() == "true"){
		    userId = "@userId";
			userName = "@userName";
		    renderDashboard(comment,view);
		}
		else{
			    if(@isPublic == true || @isUnlisted == true && isUserAuthenticated.toLowerCase() == "false"){
		 enableComment = "false";
		 enableView = "false";
		 renderDashboard(comment,view);
		}
		else{
				    if(isUserAuthenticated.toLowerCase() == "false" && token != ""){
		        enableComment = "false";
		        enableView = "false";
		        renderDashboard(comment,view);
		        $("#dashboard").data("ejDashboardViewer").model.accessToken = token;
		}
		}
		}
		}
		});
    function renderDashboard(comment,view){
        var waitingpopup = $("#dashboard-view-toogle").ejWaitingPopup();
        dashboardviewerObj = $('#dashboard').data("ejDashboardViewer");
        window.onresize = SavedViewHeight;
        var windowwidth = $(window).width();

        var te = "@Html.Raw(itemLocation)";
        var ReportName = "@ViewBag.ItemName";
        var ReportDescription = "@ViewBag.ItemDescription";
        var authentication = "@isUserAuthenticated";
		if(enableComment.toLowerCase() == "false"){
            $("ul.options #comments").css("display","none");
        }
        else{
            $("ul.options #comments").css("display","block");
        }
        if(enableView.toLowerCase() == "false"){
            $("ul.options #views").css("display","none");
        }
        else{
            $("ul.options #views").css("display","block");
        }

		var browser = ej.browserInfo();
        var showSave = "";
        var showSaveAs = "";
        var viewSavedIcon = "";
		var commentShow = "";


        $("#pin-widget-popup").ejDialog({
            width: "400px",
            height: "310px",
            showOnInit: false,
            allowDraggable: true,
            enableResize: false,
            title: "[[[Pin Item to the Homepage]]]",
            enableModal: true,
            showHeader: false
        });
        $("#pin-widget-popup_wrapper").ejWaitingPopup();
       	if(authentication.toLowerCase()== "true" && comment == ""){
				 commentShow = @enableComment;
		 }
		else if(comment != ""){
		commentShow = (comment == "true")? true :false;
		}
		else{
		commentShow = false;
		}
		var enableFavoriteSettings = (isUnlisted ) ?   (isOwner ? @enableComment : false) : @enableComment;

		if (browser != null && browser.name === "msie" && parseFloat(browser.version) <= 8.0) {
            var divString = '<div style="top:20%;width:575px;margin:0px auto;position:relative;text-align:center">' +
                '<div style="padding:35px 68px 35px 68px;" class="e-dbrd-control-container">' +
                '<p style="font-size:18px;font-weight:bold">[[[Internet Explorer 8 and Internet Explorer 11 in Enterprise Mode are not supported]]]</p>' +
                '<p style="font-size:10px">[[[Please upgrade to a newer browser if you are using IE8 or turn off Enterprise Mode if you are using IE11 in Enterprise Mode.]]]</p>' +
                '<p style="text-align:left;margin-top:20px">[[[Supported Browsers:]]]</p><div class="alert-ie">' +
                '<div><span><img  src="@Url.Content("~/api/themes/common-images/IE.png")" /></span><p>Internet Explorer 9+</p> </div> ' +
                '<div><span><img  src="@Url.Content("~/api/themes/common-images/Edge.png")" /> </span><p>Microsoft Edge</p></div>' +
                '<div><span><img  src="@Url.Content("~/api/themes/common-images/Firefox.png")" /></span><p>Mozilla Firefox 22+</p></div>' +
                '<div><span><img  src="@Url.Content("~/api/themes/common-images/Chrome.png")" /></span><p>Chrome 17+</p></div>' +
                '<div><span><img  src="@Url.Content("~/api/themes/common-images/Opera.png")" /></span><p>Opera 12+</p></div>' +
                '<div><span><img  src="@Url.Content("~/api/themes/common-images/Safari.png")" /></span><p>Safari 5+</p></div></div></div>'
            var body = document.getElementById("dashboard");
            body.style.backgroundColor = "white";
            body.innerHTML = divString;
        } else {
            if (viewId != null && viewId != "")
            {
                var viewName = "";
                var canUpdate = false;
                var link = "";
                $.ajax({
                    type: "POST",
                    url: getViewParameterUrl,
                    data: { ViewId: viewId, UserId: userId, UserName: userName, itemid: item_Id, IsMultiDashboard: isMultiDashboard, parentDashboardId: "@parentId" },
                    success: function (data) {
                        var viewDetails;
                        if (data.viewDetails != null && data.viewDetails != '') {
                            if (data.isPublic|| data.isUnlisted) {
                                viewDetails = data.viewDetails;
                                viewName = viewDetails.ViewName;
                                parameter = viewDetails.QueryString;
                                canUpdate = viewDetails.CanEdit;
                            } else {
                                viewDetails = JSON.parse(data.viewDetails);
                                viewName = viewDetails.ViewName;
                                parameter = viewDetails.QueryString;
                                canUpdate = viewDetails.CanEdit;
                            }
                        }
                        else {
                            window.location.href = window.location.href.replace(window.location.search, "");
                        }
						if(@enableView == true && authentication.toLowerCase() == "true" && view == ""){
                            showSave =  $("#is_mobile").val() == "false" ? viewDetails.CanEdit : false;
                            showSaveAs = @enableView;
							viewSavedIcon = @enableView;
						}
						else if(view != ""){
						  showSave =  $("#is_mobile").val() == "false" ? viewDetails.CanEdit : false;
                            showSaveAs = (view == "true") ? true :false;
							viewSavedIcon = (view == "true") ? true :false;
						}
                        else{
                            showSave = false;
                            showSaveAs = false;
							viewSavedIcon = false;
                        }
                        $("#dashboard").ejDashboardViewer({
                            accessToken : token,
							serviceUrl: "@dashboardServiceUrl",
                            dashboardPath: te,
                            reportName: ReportName,
                            reportDescription: ReportDescription,
                            enableExport: true,
                            enablePrint: false,
                            enableFilterOverview:true,
                            localeSettings: {
                                resourcePath: "",
                                culture: "@ViewBag.Culture"
                            },
                            interactionSettings: {
                                allowHistoryMaintenance: true,
                                handleHistoryEvent: false
                            },
                            _selectedTabGuid : childDesignerId,
                            tabActive: function(args) {
                                $("#dashboard").data("ejDashboardViewer").model.dashboardCreated = "";
                                item_Id = $("#dashboard").data("ejDashboardViewer")._getCurrentDashboardGuid();
                                $("#dashboard_Comment").attr("data-item-id", item_Id);
                                $("#favorite_Item").attr("data-item-id", item_Id);
                                $("#favorite_Item").attr("data-favorite-value", "false");
                                if ($("#comments").hasClass('active')) {
                                    var itemId = $("#dashboard_Comment").attr("data-item-id");
                                    window.frames[0].GetAllComments(itemId, "dashboard", itemId, "desc", isMultiDashboard);
                                }
                                resetViewPanel();
                                filterView();
                                $.ajax({
                                    type: "POST",
                                    url: "@Url.Action("GetCommentedWidgets", "DashboardViews")",
                                    data: {
                                        designerId: item_Id,
                                        parentId : $("#favorite_Item").attr("data-parent-id")
                                    },
                                    success: function(data) {
                                        var commentObj = { isDashboardCommented: data.IsDashboardCommented.toLowerCase() == "true", isWidgetCommented: true, widgets: data.Result };
                                        if(data.IsDashboardCommented.toLowerCase() == "true")
                                        {
                                           (iframeUrl == parentUrl) ? parent.$("ul.options li#comments span.su-without-comment").addClass("su-with-comment").removeClass("su-without-comment") : $("ul.options li#comments span.su-without-comment").addClass("su-with-comment").removeClass("su-without-comment");
                                        }
                                        else{
                                            (iframeUrl == parentUrl) ? parent.$("ul.options li#comments span.su-with-comment").addClass("su-without-comment").removeClass("su-with-comment") : $("ul.options li#comments span.su-with-comment").addClass("su-without-comment").removeClass("su-with-comment");
                                        }
                                        $("#dashboard").ejDashboardViewer("instance").applyComments(commentObj);
                                        $("#dashboard").ejDashboardViewer("instance").option("favoriteSettings.isFavorite", data.IsDashboardFavorite.toLowerCase() == "true");
                                        $("#favorite_Item").attr("data-favorite-value", data.IsDashboardFavorite.toLowerCase());
                                        $('#dashboard').data("ejDashboardViewer").model.filterOverviewSettings.viewName = null;
                                        $('#dashboard').data("ejDashboardViewer").model.filterOverviewSettings.viewId = null;
                                    }
                                });
                                if(iframeUrl == parentUrl) {
                                var currentUrl = parent.$("#current-url").attr("data-url");
                                var tabName = $("#dashboard").data("ejDashboardViewer").getCurrentTab().tabName;
                                var stateObj = window.top.history.state;
                                if(window.innerWidth >= 1041 && history.pushState != undefined) {
                                    if (currentUrl != undefined) {
                                        var index = currentUrl.indexOf("&tab=");
                                        if (index > 0) {
                                            var tempUrl = currentUrl.substring(0, index);
                                            window.top.history.replaceState(stateObj, "DashboardViewer", tempUrl + "&tab=" + tabName);
                                        } else {
                                            window.top.history.replaceState(stateObj, "DashboardViewer", currentUrl + "&tab=" + tabName);
                                        }
                                    } else {
                                        window.top.history.replaceState(stateObj, "DashboardViewer", window.location.pathname + "?tab=" + tabName);
                                    }
                                }
                            }
                            },
                            onFilterOverviewUpdated:"onFilterOverviewUpdated",
                            filterParameters: parameter,
                            onDashboardCommented: "openDashboardComment",
                            onWidgetCommented: "openWidgetComment",
                            onCommentDialogClosing: "closeComment",
                            _itemViewId:"@ViewBag.ViewId",
                            _isPublic : @isPublic,
							 _isUnlisted : @isUnlisted,
                            _unlistedCode : "@unlistedcode",
                            _itemId: "@_itemId",
                            _openShareDialog:"ShareView",
                            allowComment: commentShow,
                            commentSettings: {
                                isDashboardCommented: @Html.Raw(ViewBag.IsDashboardCommented),
                                widgets: [@Html.Raw(ViewBag.CommentedWidgets)]
                            },
                            favoriteSettings:{
                                enabled: enableFavoriteSettings,
                                isFavorite:"@(ViewBag.IsFavorite.ToString().ToLower())"=="true",
                            },
                            beforeDashboardIconRendered: "beforeDashboardIconRendered",
                            onMenuIconClick: function(information){
                                if(information.name == "Pin Widget"){
                                    $("#pin-widget-popup").ejDialog("open");
                                    $("#pin-widget-popup_wrapper").ejWaitingPopup("show");
                                    $("#pin-widget-popup-iframe").attr("src", pinWidgetToHomepageUrl);
                                    $("#pin-widget-popup").attr("data-widget-id",information.widgetId).attr("data-widget-name",information.headertext);
                                    $("#pin-widget-popup").attr("data-tab-id",information.tabId != null ? information.tabId : null);
                                }
                            },
                            onFavoriteStateChange: "updatefavorite",
                            dashboardCreated : "openComments",
                            resizeDashboard :"closeCommentOnResize",
                            filterPanelSettings: {
                                showIcon: false,
                                filterPanelId: "filter-view",
                                showHeader: false
                            },
                            filterOverviewSettings: {
                                showSaveIcon: showSave,
                                showSaveAsIcon: showSaveAs,
                                showViewSavedFilterIcon: viewSavedIcon,
                                viewName: viewDetails.ViewName,
                                viewId : "@ViewBag.ViewId"
                            },
                            onSaveFilter: "SaveFilter",
                            onSaveAsFilter: "SaveFilter",
                            onViewSavedFilters: "openViewSection",
							showGetLinkIcon:false
                        });

                        $("#current-view").show();
                        $("#current-view").html("");
                        if (canUpdate) {
                            $("#saved-filter-update").show();
                            $("#update-view").addClass("pointer-events");
                            $("#update-view").css("opacity",0.5);
                        } else {
                            $("#saved-filter-Saveas").show();
                        }
                        $("#save-section").hide();
                        $("#save-lable-section label").html("");

                        link = '<a class="saved-view-link txt-overflow" href="' +
                            pageurl +
                            '?viewid=' +
                            viewId +
                            '" target="_blank" data-toggle="tooltip" data-original-title="' + viewName + '">' +
                            viewName +
                            '</a>';
                        $("#save-lable-section label").append(link);
                        $("#save-lable-section").show();
                        $("#new-save").hide();
                        $("#unsaved-filter,#unsaved-filter-title").show();
                        $('.saved-view[viewid="' + viewId + '"').css("background-color", "#f9f9f9");
                    },
                    error: function () {
                        window.location.href = window.location.href.replace(window.location.search, "");
                    }
                });
            }else {
			if(@enableView == true && authentication.toLowerCase() == "true" && view == ""){
                            showSave =  @enableView;
                            showSaveAs = @enableView;
							viewSavedIcon = @enableView;
                        }
						else if(view != ""){
						  showSave =  (view == "true") ? true :false;
                            showSaveAs = (view == "true") ? true :false;
							viewSavedIcon = (view == "true") ? true :false;
						}
                        else{
                            showSave = false;
                            showSaveAs = false;
							viewSavedIcon = false;
                        }
                $("#dashboard").ejDashboardViewer({
                    accessToken : token,
					serviceUrl: "@dashboardServiceUrl",
                    dashboardPath: te,
                    reportName: ReportName,
                    reportDescription: ReportDescription,
                    enableExport: true,
                    enablePrint: false,
                    enableFilterOverview:true,
                    _selectedTabGuid : childDesignerId,
                    tabActive: function(args) {
                        $("#dashboard").data("ejDashboardViewer").model.dashboardCreated = "";
                        item_Id = $("#dashboard").data("ejDashboardViewer")._getCurrentDashboardGuid();
                        $("#dashboard_Comment").attr("data-item-id", item_Id);
                        $("#favorite_Item").attr("data-item-id", item_Id);
                        $("#favorite_Item").attr("data-favorite-value", "false");
                        if ($("#comments").hasClass('active')) {
                            var itemId = $("#dashboard_Comment").attr("data-item-id");
                            window.frames[0].GetAllComments(itemId, "dashboard", itemId, "desc", isMultiDashboard);
                        }
                        resetViewPanel();
                        filterView();
                        $.ajax({
                            type: "POST",
                            url: "@Url.Action("GetCommentedWidgets", "DashboardViews")",
                            data: {
                                designerId: item_Id,
                                parentId : $("#favorite_Item").attr("data-parent-id")
                            },
                            success: function(data) {
                                var commentObj = { isDashboardCommented: data.IsDashboardCommented.toLowerCase() == "true", isWidgetCommented: true, widgets: data.Result };
                                if(data.IsDashboardCommented.toLowerCase() == "true")
                                {
                                    (iframeUrl == parentUrl) ? parent.$("ul.options li#comments span.su-without-comment").addClass("su-with-comment").removeClass("su-without-comment") : $("ul.options li#comments span.su-without-comment").addClass("su-with-comment").removeClass("su-without-comment");
                                }
                                else{
                                    (iframeUrl == parentUrl) ? parent.$("ul.options li#comments span.su-with-comment").addClass("su-without-comment").removeClass("su-with-comment") : $("ul.options li#comments span.su-with-comment").addClass("su-without-comment").removeClass("su-with-comment");
                                }
                                $("#dashboard").ejDashboardViewer("instance").applyComments(commentObj);
                                $("#dashboard").ejDashboardViewer("instance").option("favoriteSettings.isFavorite", data.IsDashboardFavorite.toLowerCase() == "true");
                                $("#favorite_Item").attr("data-favorite-value", data.IsDashboardFavorite.toLowerCase());
                                $('#dashboard').data("ejDashboardViewer").model.filterOverviewSettings.viewName = null;
                                $('#dashboard').data("ejDashboardViewer").model.filterOverviewSettings.viewId = null;
                            }
                        });

                        if(iframeUrl == parentUrl){
                        var currentUrl = parent.$("#current-url").attr("data-url");
                        var tabName = $("#dashboard").data("ejDashboardViewer").getCurrentTab().tabName;
                        var stateObj = window.top.history.state;
                        if(window.innerWidth >= 1041 && history.pushState != undefined) {
                            if (currentUrl != undefined) {
                                var index = currentUrl.indexOf("&tab=");
                                if (index > 0) {
                                    var tempUrl = currentUrl.substring(0, index);
                                    window.top.history.replaceState(stateObj, "DashboardViewer", tempUrl + "&tab=" + tabName);
                                } else {
                                    window.top.history.replaceState(stateObj, "DashboardViewer", currentUrl + "&tab=" + tabName);
                                }
                            } else {
                                window.top.history.replaceState(stateObj, "DashboardViewer", window.location.pathname + "?tab=" + tabName);
                            }
                        }
                    }
                    },
                    localeSettings: {
                        resourcePath: "",
                        culture: "@ViewBag.Culture"
                    },
                    interactionSettings: {
                        allowHistoryMaintenance: true,
                        handleHistoryEvent: false
                    },
                    onFilterOverviewUpdated:"onFilterOverviewUpdated",
                    filterParameters: "@Html.Raw(ViewBag.FilterQuery)",
                    onDashboardCommented: "openDashboardComment",
                    onWidgetCommented: "openWidgetComment",
                    onCommentDialogClosing: "closeComment",
                    _itemViewId: "@ViewBag.ViewId",
                    _isPublic : @isPublic,
					 _isUnlisted : @isUnlisted,
                    _unlistedCode : "@unlistedcode",
                    _itemId: "@_itemId",
                    _openShareDialog:"ShareView",
                    allowComment: commentShow,
                    commentSettings: {
                        isDashboardCommented: @Html.Raw(ViewBag.IsDashboardCommented),
                        widgets: [@Html.Raw(ViewBag.CommentedWidgets)]
                    },
                    favoriteSettings:{
                        enabled: enableFavoriteSettings,
                        isFavorite:"@(ViewBag.IsFavorite.ToString().ToLower())"=="true",
                    },
                    beforeDashboardIconRendered: "beforeDashboardIconRendered",
                    onMenuIconClick: function(information){
                        if(information.name == "Pin Widget"){
                            $("#pin-widget-popup").ejDialog("open");
                            $("#pin-widget-popup_wrapper").ejWaitingPopup("show");
                            $("#pin-widget-popup-iframe").attr("src", pinWidgetToHomepageUrl);
                            $("#pin-widget-popup").attr("data-widget-id",information.widgetId).attr("data-widget-name",information.headertext);
                            $("#pin-widget-popup").attr("data-tab-id",information.tabId != null ? information.tabId : null);
                        }
                    },
                    onFavoriteStateChange: "updatefavorite",
                    dashboardCreated : "openComments",
                    resizeDashboard :"closeCommentOnResize",
                    filterPanelSettings: {
                        showIcon: false,
                        filterPanelId: "filter-view",
                        showHeader: false
                    },
                    filterOverviewSettings: {
                        showSaveIcon: showSave,
                        showSaveAsIcon: showSaveAs,
                        showViewSavedFilterIcon: viewSavedIcon,
                        viewName: null,
                        viewId : null
                    },
                    onSaveFilter: "SaveFilter",
                    onSaveAsFilter: "SaveFilter",
                    onViewSavedFilters: "openViewSection",
					showGetLinkIcon:false
                });
            }
        }
        setWidth();
        if(iframeUrl !== parentUrl) {
            var obj = $("#dashboard").ejDashboardViewer("instance");
            obj.model.interactionSettings.allowHistoryMaintenance = false;
            obj.model.interactionSettings.handleHistoryEvent = false;
        }
    }

    $(document).on("click", ".close-div", function () {
        (iframeUrl == parentUrl )? parent.$('#warning-alert').fadeOut() : $('#warning-alert').fadeOut();
    });

    function setWidth() {
        $("#dashboard").css("width", $(window).width() - 40 + "px");
        if ($("#comments, #filters, #views").hasClass('active')) {
            $("#dashboard").css("width", $(window).width() - 450 + "px");
        }
    }

    function applyFilter() {
        var url = window.parent.location.search;
        var tabName = getUrlQueryVariable(url,"tab");
        if (tabName != undefined && tabName != "") {
            $("#dashboard").data("ejDashboardViewer").selectTabByName(decodeURI(tabName));
        } else if (isMultiDashboard.toLowerCase() === "true"){
            $("#dashboard").data("ejDashboardViewer").selectTabByIndex(0);
        }

        var stateObj = window.top.history.state;
        if (stateObj != undefined) {
            var currentViewId = JSON.parse(stateObj)['sync-dbrd-key'];
            if (currentViewId != undefined && currentViewId != "") {
                $("#dashboard").data("ejDashboardViewer").loadHistoryData(currentViewId);
            }
        }
    }

    function beforeDashboardIconRendered(args){
        if(!ej.isNullOrUndefined(args) && !ej.isNullOrUndefined(args.iconsinformation)) {
            var index = null;
            for(var i=0; i < args.iconsinformation.length; i++) {
                if(args.iconsinformation[i].name === "comment") {
                    index = i;
                    break;
                }
            }
            if(!ej.isNullOrUndefined(index)) {
                args.iconsinformation.splice(index, 1);
            }
        }
    }

    function getUrlQueryVariable(url, variable) {
        var query = url.substring(url.indexOf('?') + 1);
        var vars = query.split("&");
        for (var i = 0; i < vars.length; i++) {
            var pair = vars[i].split("=");
            if (pair[0] == variable) { return pair[1]; }
        }
        return null;
    }
</script>
