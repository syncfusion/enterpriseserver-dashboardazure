@{
    Layout = null;
    var datasourceList = ViewData["ItemsList"] as List<ItemDetail>;
    var dataSourceNames = ViewData["DataSourceName"] as List<string>;
    var datasourceNameList = ViewData["DataSourceNamesList"];
    var isDataSourceUpdated = ViewData["IsDatasourceUpdated"] != null ? Convert.ToBoolean(ViewData["IsDatasourceUpdated"]) : false;
}
<!DOCTYPE html>
<html>
@if (dataSourceNames.Count != 0)
{
    <head>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0">
        <title>
            [[[Update Data Source(s)]]]
        </title>
        @Styles.Render("~/styles/update-datasource")
        @Scripts.Render("~/scripts/update-datasource")
        <script>
            var updatedatasourceUrl = "@Url.Action("updatedatasource", "dashboards")";
            var getActiveandInactiveUserUrl = "@Url.Action("Getallactivegroupsandusers", "Accounts")";
            var deleteAssignedGroupUrl = "@Url.Action("DeleteAssignedGroup", "dashboards")";
            var getDatasourceUrl = "@Url.Action("GetMappedDataSources", "dashboards")";
            var dashboardItemId = "@ViewData["ItemId"]";
            getAllStaticData();
        </script>
        <script type="text/x-jsrender" id="commandstemplate">
            <div>
                <span id="edit-assigned-group" class="su su-edit" data-toggle="tooltip" title="[[[Edit]]]" style="cursor: pointer"><a href="javascript:void(0);" data-group-name="{{:GroupName}}" data-group-id="{{:GroupId}}"></a></span>
                <span class="divider" role="separator"></span>
                <span id="delete-assigned-group" class="su su-delete" data-toggle="tooltip" title="[[[Delete]]]" style="cursor: pointer"><a href="javascript:void(0);" data-item-id="@ViewData["ItemId"]" data-group-id="{{:GroupId}}" data-datasource-id="{{:DataSourceId}}" data-datasource-name="{{:DataSourceName}}"></a></span>
            </div>
        </script>
        <script type="text/x-jsrender" id="mappeddatasourcename">
            <div class="item-description grid-content" title="{{:SharedDataSourceName}}" data-toggle="tooltip" data-placement="top">
                <span>
                    {{:SharedDataSourceName}}
                </span>
            </div>
        </script>
        <script type="text/x-jsrender" id="datasourcename">
            <div class="item-description grid-content" title="{{:DataSourceName}}" data-toggle="tooltip" data-placement="top">
                <span>
                    {{:DataSourceName}}
                </span>
            </div>
        </script>

        <script type="text/javascript">
        $(function () {
            if ((@Json.Encode(isDataSourceUpdated))) {
                var updatedDataSource = @Html.Raw(Json.Encode(ViewBag.UpdatedDataSourceDetails));
                var selectContents = parent.$("#update-data-source-popup-iframe").contents().find("select");
                $(selectContents).each(function (index, value) {
                    for (var i = 0; i < updatedDataSource.length; i++) {
                        //For All users only
                        if (this.name == updatedDataSource[i].DataSourceName && updatedDataSource[i].GroupId == null) {
                            $(this).attr("data-original-value",updatedDataSource[i].DataSourceId);
                            $(this).val(updatedDataSource[i].DataSourceId);
                            $(this).selectpicker("refresh");
                        }
                    }
                });
            }
            window.parent.ShowWaitingProgress("#update-data-source-popup_wrapper", "hide");
        });
        </script>
        <script type="text/javascript">
            if ($("#group-search option").length > 0)
                $(".share-popup #group-search-container .bs-deselect-all").after("<div><span class='bs-select-custom-tick glyphicon glyphicon-ok'></span></div>");
            else
                $(".share-popup #group-search-container .bs-deselect-all").after("<span class='noResult'>[[[No Results Found]]]</span>");


            $("#group-search-container").on("click", ".bootstrap-select .dropdown-menu .selectpicker li a", function (e) {
                $("#group-search-container").addClass("value-changed");;
                var selectedCount = $("#group-search-container .bootstrap-select li.selected").length;
                var allListCount = $("#group-search-container .bootstrap-select li").length;

                if ($(this).parent().hasClass("selected")) {
                    var selectedGroup = $("#group-search").find("option")[parseInt($(this).parent().attr("data-original-index"))];
                    var groupTile = $("<div>").attr("id", $(selectedGroup).val()).attr("data-searchtype", "groupSearch").addClass("selected-share-items");
                    groupTile.html("<div class='instant-search'><span class='details' title='" + $(selectedGroup).text() + "'>" + $(selectedGroup).text() + "</span><div style='width:auto' class='instant-cancel'><span class='su su-close i-selected-cancel'/></div></div>");
                    $("#selected-users").append(groupTile);
                }
                else {
                    var selectedGroup = $("#group-search").find("option")[parseInt($(this).parent().attr("data-original-index"))];
                    $(".selected-share-items").filter("[data-searchtype='groupSearch']").filter("#" + $(selectedGroup).val()).remove();
                }
                $(this).parent().addClass("active");
                e.stopPropagation();
            });
        </script>
        <script>
        $(document).ready(function () {
            $("#groupsListGrid").ejGrid({
                gridLines: ej.Grid.GridLines.Horizontal,
                allowPaging: true,
                filterSettings: { filterType: "excel" },
                allowSorting: true,
                pageSettings: { pageSize: 10 },
                dataBound: function (args) {
                    $('[data-toggle="tooltip"]').tooltip();
                },
                rowDataBound: function (args){
                    $('[data-toggle="tooltip"]').tooltip();
                },
                columns: [
                    {
                        headerText: "Group",
                        allowSorting: true,
                        field: "GroupName",
                        width: 25
                    },
                    {
                        headerText: "Data Source",
                        field: "DataSourceName",
                        templateID: "#datasourcename",
                        width: 25
                    },
                    {
                        headerText: "Mapped Data Source",
                        field: "SharedDataSourceName",
                        templateID: "#mappeddatasourcename",
                        width: 25
                    },
                    {
                        headerText: "Actions",
                        templateID: "#commandstemplate",
                        width: 25
                    }
                ]
            });
            $('[data-toggle="tooltip"]').tooltip();
        });

        function loadGroupNames(){
            var gridObj = $("#groupsListGrid").data("ejGrid");
            var dashboardItemId = "@ViewData["ItemId"]";
            var dataSourceNamesList = @Html.Raw(datasourceNameList);
            var dataSourceNamesJson = JSON.stringify(dataSourceNamesList);
            var data = new ej.DataManager({
                url: "@Url.Action("GetMappedGroupNameList", "dashboards")?dashboardItemId=" + dashboardItemId + "&datasourceNameList=" + dataSourceNamesJson,
                adaptor: new ej.UrlAdaptor()
            });
            if(gridObj != null){
                gridObj.dataSource(data);
                gridObj.model.pageSettings.currentPage = 1;
            }
        }
        </script>

    </head>
    <body id="datasource-update">
        <div class="col-md-12 header-menu dialog-header">
            <span class="su su-nav-datasource Head-icon"></span>
            <span class="PopupTitle modal-title">[[[Update Data Source(s)]]]</span>
            <div class="dashboard-name report-name">
                <span>[[[Update data sources connected to the Dashboard -]]]&nbsp;</span>
                <span class="item-name" data-toggle="tooltip" data-placement="bottom" data-original-title="@ViewBag.FullItemName">@ViewBag.FullItemName</span>
            </div>
            <a href="javascript:void(0);" data-toggle="tooltip" data-placement="left" data-container="body" title="[[[Close]]]" class="PopupClose" onclick="closeUpdateDataSourcePopup()"><span class="su su-close"></span></a>
        </div>
        <div>
            <ul id="assign-group-nav" class="nav nav-tabs" role="tablist">
                <li role="presentation" class="active">
                    <a href="#datasource-popup-module" id="assign-group" aria-controls="datasource-popup-module" role="tab" data-toggle="tab">[[[Assign Data Sources]]]</a>
                </li>
                <li role="presentation">
                    <a href="#assigned-group-content" id="assigned-group" aria-controls="assigned-group-content" role="tab" data-toggle="tab">[[[Assigned Data Sources]]]</a>
                </li>
            </ul>
        </div>
        <div class="tab-content">
            <div id="datasource-popup-module" role="tabpanel" class="tab-pane active">
                <div class="datasource-btns dialog-footer">
                    <div class="pull-right">
                        <input type='button' title='' value='[[[Cancel]]]' class='btn secondary-button' onclick="closeUpdateDataSourcePopup()" tabindex="18">
                    </div>
                </div>
                <form id='new-datasource-tab-content' class='col-md-12 update-datasource-tab-contents' autocomplete="off">
                    <div class='col-md-12 no-top-margin new-datasource-content-holder pull-left' id='new-datasource-content-holder'>
                        <table width="100%" cellspacing="10px" cellpadding="0" border="0">
                            <tr>
                                <th>[[[Data Source]]]</th>
                                <th colspan="2">[[[Assign Data Source]]]</th>
                            </tr>
                            @for (var i = 0; i < dataSourceNames.Count; i++)
                    {
                        <tr>
                            <td>
                                @dataSourceNames[i]
                            </td>
                            <td>
                                <div id="data-source-container">
                                    <select id="datasource-search" data-live-search="true" class="selectpicker update-datasource form-control" data-size="5" data-container="body" name="@dataSourceNames[i]" data-original-value="null">
                                        <option class="select-data-source" value="00000000-0000-0000-0000-000000000000">[[[Embedded Data Source]]]</option>
                                        <option data-divider="true"></option>
                                        @for (var item = 0; item < datasourceList.Count; item++)
                                {
                                    <option value="@datasourceList[item].Id">@datasourceList[item].Name</option>
                        }
                                    </select>
                                </div>
                            </td>
                            <td>
                                <span id="add-new-datasource" class="su-add" data-toggle="tooltip" data-placement="left" title="[[[Add new Data Source]]]"></span>
                            </td>
                        </tr>
            }
                            <tr></tr>
                        </table>
                        <div class="share-popup col-xs-12">
                            <div class="col-xs-2 left-align"><label class="text-center">Save to</label></div>
                            <div class="col-xs-4 dropup save-mode">
                                <select class="selectpicker" data-size="2">
                                    <option>[[[All Users]]]</option>
                                    <option>[[[Group]]]</option>
                                </select>
                            </div>
                            <div id="group-search-container" class="col-xs-4 dropup i-search-fields not-visible">
                                <select id="group-search" class="selectpicker" data-size="5" data-live-search="true" data-none-results-text="[[[No results match]]]" data-live-search-placeholder="Search" title="[[[Select Groups]]]"></select>
                            </div>
                            <div class="col-xs-2">
                                <input type='button' title='' id="share-datasource-with-group" value='[[[Save]]]' class='btn primary-button' data-item-id=@ViewData["ItemId"] data-mapid="name" tabindex="17">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div id="assigned-group-content" role="tabpanel" class="tab-pane">
                <div id="groupsListGrid"> </div>
                <div class="footer-btns">
                    <div class="pull-right">
                        <input type='button' title='' value='[[[Cancel]]]' class='btn secondary-button' onclick="closeUpdateDataSourcePopup()" tabindex="18">
                    </div>

                </div>
                </div>
            </div>
</body>
}

else
{
    <head>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0">
        @Styles.Render("~/styles/update-datasource")
        @Scripts.Render("~/scripts/update-datasource")
        <script>
            $(document).ready(function () {
                closeUpdateDataSourcePopup();
                parent.messageBox("su-update-data-source", "[[[Update Data Source(s)]]]", "[[[Internal server error. Please try again.]]]", "success", function () {
                    parent.onCloseMessageBox();
                });
            });
        </script>
    </head>
}
</html>